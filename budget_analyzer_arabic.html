<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ù„Ù„ Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.9;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .file-upload {
            border: 3px dashed #2a5298;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: #1e3c72;
            background: #f0f2ff;
            transform: translateY(-2px);
        }

        .file-upload input {
            display: none;
        }

        .upload-text {
            font-size: 1.2em;
            color: #555;
            margin-top: 15px;
        }

        .upload-icon {
            font-size: 3.5em;
            color: #2a5298;
            margin-bottom: 15px;
        }

        .sample-data-btn {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            margin: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .sample-data-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .analysis-section {
            display: none;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-value {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .summary-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        @media (max-width: 1200px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .chart-title {
            text-align: center;
            font-size: 1.4em;
            margin-bottom: 20px;
            color: #1e3c72;
            font-weight: 600;
        }

        .full-width-chart {
            grid-column: 1 / -1;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .sector-percentages {
            margin-top: 15px;
            font-size: 0.9em;
        }

        .sector-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .sector-item:last-child {
            border-bottom: none;
        }

        .sector-name {
            font-weight: 600;
        }

        .sector-percentage {
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        @media (max-width: 1024px) {
            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }

        .data-table-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .insights-container {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .insights-container h3 {
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .insight-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
            line-height: 1.6;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th, td {
            padding: 12px 8px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        th {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .budget-column {
            background: #e8f5e8 !important;
        }

        .actual-column {
            background: #fff2e8 !important;
        }

        .remaining-column {
            background: #e8f2ff !important;
        }

        .negative-remaining {
            background: #ffe8e8 !important;
            color: #d32f2f;
            font-weight: bold;
        }

        .positive-remaining {
            background: #e8f5e8 !important;
            color: #2e7d32;
            font-weight: bold;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
            font-size: 1.3em;
            color: white;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .export-section {
            text-align: center;
            margin: 20px 0;
        }

        .export-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            margin: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .filters-section {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .filter-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: 600;
            color: #1e3c72;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .cost-center-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #2a5298;
        }

        .cost-center-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .cost-center-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #1e3c72;
        }

        .cost-center-code {
            background: #f0f2ff;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            color: #2a5298;
        }

        .budget-progress {
            background: #f5f5f5;
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .budget-progress-bar {
            height: 100%;
            transition: width 0.3s ease;
        }

        .over-budget {
            background: linear-gradient(90deg, #ff4757, #ff3838);
        }

        .under-budget {
            background: linear-gradient(90deg, #2ed573, #1dd1a1);
        }

        .warning-budget {
            background: linear-gradient(90deg, #ffa502, #ff6348);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }

            table {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’¼ Ù…Ø­Ù„Ù„ Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª</h1>
            <p>ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ ÙˆÙ…ØªÙ‚Ø¯Ù… Ù„Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ø¹ ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ</p>
        </div>

        <div class="upload-section">
            <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">ğŸ“Š</div>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFile(this)">
                <div class="upload-text">
                    <strong>Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø£Ùˆ CSV</strong><br>
                    Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù ÙˆØ£ÙÙ„ØªÙ‡ Ù‡Ù†Ø§<br>
                    <small>ÙŠØ¯Ø¹Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª</small>
                </div>
            </div>
           
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±...
        </div>

        <div class="analysis-section" id="analysisSection">
            <div class="export-section">
                <button class="export-btn" onclick="printReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                <button class="export-btn" onclick="exportToExcel()">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
                <button class="export-btn" onclick="exportToPDF()">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
            </div>

            <div class="filters-section">
                <h3>ğŸ” Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª ÙˆØ§Ù„ÙÙ„Ø§ØªØ±</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©:</label>
                        <select id="costCenterFilter" onchange="applyFilters()">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨:</label>
                        <select id="accountTypeFilter" onchange="applyFilters()">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©:</label>
                        <input type="number" id="budgetMinFilter" onchange="applyFilters()" placeholder="0">
                    </div>
                    <div class="filter-group">
                        <label>Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©:</label>
                        <select id="budgetStatusFilter" onchange="applyFilters()">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                            <option value="over">ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</option>
                            <option value="warning">Ø§Ù‚ØªØ±Ø§Ø¨ Ù…Ù† Ø§Ù„Ø­Ø¯</option>
                            <option value="under">Ø¶Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Ø§Ù„Ø´Ù‡Ø±:</label>
                        <select id="monthFilter" onchange="applyFilters()">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´Ù‡Ø±</option>
                            <option value="ÙŠÙ†Ø§ÙŠØ±">ÙŠÙ†Ø§ÙŠØ±</option>
                            <option value="ÙØ¨Ø±Ø§ÙŠØ±">ÙØ¨Ø±Ø§ÙŠØ±</option>
                            <option value="Ù…Ø§Ø±Ø³">Ù…Ø§Ø±Ø³</option>
                            <option value="Ø£Ø¨Ø±ÙŠÙ„">Ø£Ø¨Ø±ÙŠÙ„</option>
                            <option value="Ù…Ø§ÙŠÙˆ">Ù…Ø§ÙŠÙˆ</option>
                            <option value="ÙŠÙˆÙ†ÙŠÙˆ">ÙŠÙˆÙ†ÙŠÙˆ</option>
                            <option value="ÙŠÙˆÙ„ÙŠÙˆ">ÙŠÙˆÙ„ÙŠÙˆ</option>
                            <option value="Ø£ØºØ³Ø·Ø³">Ø£ØºØ³Ø·Ø³</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="summary-cards" id="summaryCards">
                <!-- Summary cards will be inserted here -->
            </div>

            <div class="charts-section">
                <div class="chart-container">
                    <h3 class="chart-title">ğŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù…Ø¹ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ</h3>
                    <canvas id="budgetVsActualChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">ğŸ“Š Ù†Ø³Ø¨ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</h3>
                    <canvas id="costCenterPieChart"></canvas>
                    <div class="sector-percentages" id="sectorPercentages">
                        <!-- Sector percentages will be inserted here -->
                    </div>
                </div>

                <div class="chart-container full-width-chart">
                    <h3 class="chart-title">ğŸ“ˆ ØªØ·ÙˆØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
                    <canvas id="monthlyTrendChart"></canvas>
                </div>

                <div class="chart-container full-width-chart">
                    <h3 class="chart-title">âš–ï¸ ØªØ­Ù„ÙŠÙ„ Ø§Ù†Ø­Ø±Ø§ÙØ§Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</h3>
                    <canvas id="varianceChart"></canvas>
                </div>
            </div>

            <div class="analysis-grid">
                <div class="data-table-container">
                    <h3 style="text-align: center; margin-bottom: 20px; color: #1e3c72;">ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</h3>
                    <div id="costCenterCards">
                        <!-- Cost center cards will be inserted here -->
                    </div>
                </div>

                <div class="insights-container">
                    <h3>ğŸ” Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª</h3>
                    <div id="insights">
                        <!-- Insights will be inserted here -->
                    </div>
                </div>
            </div>

            <div class="data-table-container">
                <h3 style="text-align: center; margin-bottom: 20px; color: #1e3c72;">ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
                <table id="dataTable">
                    <!-- Table content will be inserted here -->
                </table>
            </div>
        </div>
    </div>

    <script>
        let originalData = [];
        let filteredData = [];
        let charts = {};

        // Sample data with ENP510600 and ENP220300, including August
        const sampleData = [
            {
                "Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©": "ENP510600",
                "Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨": "31013000",
                "Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„": "Ø´Ø¦ÙˆÙ† Ø§Ø¯Ø§Ø±ÙŠÙ‡",
                "Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨": "Ø§Ù„Ø²Ù‰ Ø§Ù„Ø±Ø³Ù…Ù‰",
                "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ÙŠÙ†Ø§ÙŠØ±": 270600,
                "Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ÙŠÙ†Ø§ÙŠØ±": 0,
                "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ÙØ¨Ø±Ø§ÙŠØ±": 0,
                "Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ÙØ¨Ø±Ø§ÙŠØ±": 0,
                "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - Ù…Ø§Ø±Ø³": 0,
                "Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - Ù…Ø§Ø±Ø³": 0,
                "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - Ø£Ø¨Ø±ÙŠÙ„": 331000,
                "Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - Ø£Ø¨Ø±ÙŠÙ„": 0,
                "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - Ù…Ø§ÙŠÙˆ": 0,
                "Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - Ù…Ø§ÙŠÙˆ": 0,
                "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ÙŠÙˆÙ†ÙŠÙˆ": 0,
                "Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ÙŠÙˆÙ†ÙŠÙˆ": 0,
                "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - Ø£ØºØ³Ø·Ø³": 0,
                "Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - Ø£ØºØ³Ø·Ø³": 0,
                "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±": 601600,
                "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±": 0,
                "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©": 601600
            },
            {
                "Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©": "ENP220300",
                "Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨": "32014000",
                "Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„": "Ø´Ø¦ÙˆÙ† Ù…Ø§Ù„ÙŠØ©",
                "Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨": "Ø§Ù„Ù†ÙÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©",
                "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ÙŠÙ†Ø§ÙŠØ±": 150000,
                "Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ÙŠÙ†Ø§ÙŠØ±": 120000,
                "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ÙØ¨Ø±Ø§ÙŠØ±": 150000,
                "Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ÙØ¨Ø±Ø§ÙŠØ±": 130000,
                "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - Ù…Ø§Ø±Ø³": 150000,
                "Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - Ù…Ø§Ø±Ø³": 110000,
                "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - Ø£Ø¨Ø±ÙŠÙ„": 150000,
                "Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - Ø£Ø¨Ø±ÙŠÙ„": 140000,
                "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - Ù…Ø§ÙŠÙˆ": 150000,
                "Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - Ù…Ø§ÙŠÙˆ": 125000,
                "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ÙŠÙˆÙ†ÙŠÙˆ": 150000,
                "Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ÙŠÙˆÙ†ÙŠÙˆ": 115000,
                "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - Ø£ØºØ³Ø·Ø³": 150000,
                "Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - Ø£ØºØ³Ø·Ø³": 120000,
                "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±": 1050000,
                "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±": 860000,
                "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©": 190000
            }
        ];

        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;

            showLoading();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        parseCSV(e.target.result);
                    } else {
                        parseExcel(e.target.result);
                    }
                } catch (error) {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message);
                    hideLoading();
                }
            };
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function parseCSV(data) {
            const lines = data.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/[\u200B-\u200D\uFEFF]/g, ''));
            console.log("CSV Headers:", headers); // Debug: Log CSV headers
            
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.trim());
                    const row = {};
                    headers.forEach((header, index) => {
                        const value = values[index]?.trim();
                        row[header] = isNaN(value) ? value : parseFloat(value) || 0;
                    });
                    rows.push(row);
                }
            }
            
            console.log("Parsed CSV Data:", rows); // Debug: Log parsed CSV data
            originalData = rows;
            processData();
        }

        function parseExcel(data) {
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            const headers = jsonData[0].map(h => h.trim().replace(/[\u200B-\u200D\uFEFF]/g, ''));
            console.log("Excel Headers:", headers); // Debug: Log Excel headers
            
            const rows = [];
            for (let i = 1; i < jsonData.length; i++) {
                if (jsonData[i].length > 0) {
                    const row = {};
                    headers.forEach((header, index) => {
                        const value = jsonData[i][index];
                        row[header] = isNaN(value) ? value : parseFloat(value) || 0;
                    });
                    rows.push(row);
                }
            }
            
            console.log("Parsed Excel Data:", rows); // Debug: Log parsed Excel data
            originalData = rows;
            processData();
        }

        function loadSampleData() {
            showLoading();
            originalData = [...sampleData];
            console.log("Loaded Sample Data:", originalData); // Debug: Log sample data
            setTimeout(() => {
                processData();
            }, 1500);
        }

        function processData() {
            if (originalData.length === 0) {
                hideLoading();
                return;
            }

            // Clean and process data
            filteredData = originalData.map(row => {
                const processedRow = { ...row };
                
                // Ensure numeric values
                const numericFields = [
                    'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ÙŠÙ†Ø§ÙŠØ±', 'Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ÙŠÙ†Ø§ÙŠØ±',
                    'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ÙØ¨Ø±Ø§ÙŠØ±', 'Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ÙØ¨Ø±Ø§ÙŠØ±',
                    'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - Ù…Ø§Ø±Ø³', 'Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - Ù…Ø§Ø±Ø³',
                    'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - Ø£Ø¨Ø±ÙŠÙ„', 'Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - Ø£Ø¨Ø±ÙŠÙ„',
                    'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - Ù…Ø§ÙŠÙˆ', 'Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - Ù…Ø§ÙŠÙˆ',
                    'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ÙŠÙˆÙ†ÙŠÙˆ', 'Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ÙŠÙˆÙ†ÙŠÙˆ',
                    'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - Ø£ØºØ³Ø·Ø³', 'Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - Ø£ØºØ³Ø·Ø³',
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±', 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©'
                ];
                
                numericFields.forEach(field => {
                    processedRow[field] = parseFloat(processedRow[field]) || 0;
                });

                // Ensure cost center is trimmed
                if (processedRow['Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©']) {
                    processedRow['Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©'] = processedRow['Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©'].toString().trim();
                }

                return processedRow;
            });

            console.log("Processed Data:", filteredData); // Debug: Log processed data
            populateFilters();
            analyzeData();
        }

        function populateFilters() {
            // Populate cost center filter
            const costCenters = [...new Set(filteredData.map(row => row['Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©']))];
            const costCenterSelect = document.getElementById('costCenterFilter');
            costCenterSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</option>';
            costCenters.forEach(center => {
                if (center && center !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
                    costCenterSelect.innerHTML += `<option value="${center}">${center}</option>`;
                }
            });

            // Populate account type filter
            const accountTypes = [...new Set(filteredData.map(row => row['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„']))];
            const accountTypeSelect = document.getElementById('accountTypeFilter');
            accountTypeSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</option>';
            accountTypes.forEach(type => {
                if (type) {
                    accountTypeSelect.innerHTML += `<option value="${type}">${type}</option>`;
                }
            });
        }

        function applyFilters() {
            const costCenterFilter = document.getElementById('costCenterFilter').value;
            const accountTypeFilter = document.getElementById('accountTypeFilter').value;
            const budgetMinFilter = parseFloat(document.getElementById('budgetMinFilter').value) || 0;
            const budgetStatusFilter = document.getElementById('budgetStatusFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;

            filteredData = originalData.filter(row => {
                // Cost center filter
                const costCenter = row['Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©'] ? row['Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©'].toString().trim() : '';
                if (costCenterFilter && costCenter !== costCenterFilter) return false;
                
                // Account type filter
                if (accountTypeFilter && row['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„'] !== accountTypeFilter) return false;
                
                // Budget minimum filter
                if (budgetMinFilter > 0 && (parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0) < budgetMinFilter) return false;
                
                // Budget status filter
                if (budgetStatusFilter) {
                    const budget = parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0;
                    const actual = parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0;
                    const remaining = parseFloat(row['Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©']) || 0;
                    
                    if (budgetStatusFilter === 'over' && remaining >= 0) return false;
                    if (budgetStatusFilter === 'warning' && (remaining < 0 || remaining > budget * 0.2)) return false;
                    if (budgetStatusFilter === 'under' && remaining <= budget * 0.2) return false;
                }

                // Month filter
                if (monthFilter) {
                    const budget = parseFloat(row[`Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${monthFilter}`]) || 0;
                    const actual = parseFloat(row[`Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ${monthFilter}`]) || 0;
                    // Only include rows where either budget or actual expense for the selected month is non-zero
                    if (budget === 0 && actual === 0) return false;
                }
                
                return true;
            });

            console.log("Filtered Data:", filteredData); // Debug: Log filtered data
            analyzeData();
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('analysisSection').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'block';
        }

        function analyzeData() {
            createSummaryCards();
            createCharts();
            createCostCenterCards();
            generateInsights();
            createDataTable();
            hideLoading();
        }

        function createSummaryCards() {
            const summary = calculateSummary();
            const summaryCards = document.getElementById('summaryCards');
            
            summaryCards.innerHTML = `
                <div class="summary-card">
                    <div class="summary-value">${filteredData.length}</div>
                    <div class="summary-label">Ø¹Ø¯Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªÙƒÙ„ÙØ©</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${formatNumber(summary.totalBudget)}</div>
                    <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ©</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${formatNumber(summary.totalActual)}</div>
                    <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${formatNumber(summary.totalRemaining)}</div>
                    <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${summary.utilizationRate.toFixed(1)}%</div>
                    <div class="summary-label">Ù…Ø¹Ø¯Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${summary.overBudgetCount}</div>
                    <div class="summary-label">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ²Ø© Ù„Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</div>
                </div>
            `;
        }

        function calculateSummary() {
            const monthFilter = document.getElementById('monthFilter').value;
            let totalBudget, totalActual, totalRemaining, utilizationRate, overBudgetCount;

            if (monthFilter) {
                // Calculate summary for the selected month
                totalBudget = filteredData.reduce((sum, row) => sum + (parseFloat(row[`Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${monthFilter}`]) || 0), 0);
                totalActual = filteredData.reduce((sum, row) => sum + (parseFloat(row[`Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ${monthFilter}`]) || 0), 0);
                totalRemaining = totalBudget - totalActual;
                utilizationRate = totalBudget > 0 ? (totalActual / totalBudget) * 100 : 0;
                overBudgetCount = filteredData.filter(row => {
                    const budget = parseFloat(row[`Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${monthFilter}`]) || 0;
                    const actual = parseFloat(row[`Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ${monthFilter}`]) || 0;
                    return actual > budget;
                }).length;
            } else {
                // Default to seven-month totals
                totalBudget = filteredData.reduce((sum, row) => sum + (parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0), 0);
                totalActual = filteredData.reduce((sum, row) => sum + (parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0), 0);
                totalRemaining = filteredData.reduce((sum, row) => sum + (parseFloat(row['Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©']) || 0), 0);
                utilizationRate = totalBudget > 0 ? (totalActual / totalBudget) * 100 : 0;
                overBudgetCount = filteredData.filter(row => (parseFloat(row['Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©']) || 0) < 0).length;
            }
            
            return {
                totalBudget,
                totalActual,
                totalRemaining,
                utilizationRate,
                overBudgetCount
            };
        }

        function createCharts() {
            createBudgetVsActualChart();
            createSectorPercentageChart();
            createMonthlyTrendChart();
            createVarianceChart();
        }

        function createBudgetVsActualChart() {
            const ctx = document.getElementById('budgetVsActualChart').getContext('2d');
            
            if (charts.budgetVsActual) {
                charts.budgetVsActual.destroy();
            }

            const monthFilter = document.getElementById('monthFilter').value;
            const labels = filteredData.map(row => row['Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨']?.substring(0, 20) + '...' || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
            let budgetData, actualData;

            if (monthFilter) {
                budgetData = filteredData.map(row => parseFloat(row[`Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${monthFilter}`]) || 0);
                actualData = filteredData.map(row => parseFloat(row[`Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ${monthFilter}`]) || 0);
            } else {
                budgetData = filteredData.map(row => parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0);
                actualData = filteredData.map(row => parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0);
            }

            charts.budgetVsActual = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ©',
                            data: budgetData,
                            backgroundColor: 'rgba(30, 60, 114, 0.7)',
                            borderColor: 'rgba(30, 60, 114, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ',
                            data: actualData,
                            backgroundColor: 'rgba(245, 87, 108, 0.7)',
                            borderColor: 'rgba(245, 87, 108, 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatNumber(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function createSectorPercentageChart() {
            const ctx = document.getElementById('costCenterPieChart').getContext('2d');
            
            if (charts.costCenterPie) {
                charts.costCenterPie.destroy();
            }

            // Group by account name (sector) and calculate budget percentages
            const sectorBudgetData = {};
            const monthFilter = document.getElementById('monthFilter').value;
            let totalBudget;

            if (monthFilter) {
                totalBudget = filteredData.reduce((sum, row) => sum + (parseFloat(row[`Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${monthFilter}`]) || 0), 0);
                filteredData.forEach(row => {
                    const sector = row['Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const budget = parseFloat(row[`Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${monthFilter}`]) || 0;
                    sectorBudgetData[sector] = (sectorBudgetData[sector] || 0) + budget;
                });
            } else {
                totalBudget = filteredData.reduce((sum, row) => sum + (parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0), 0);
                filteredData.forEach(row => {
                    const sector = row['Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const budget = parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0;
                    sectorBudgetData[sector] = (sectorBudgetData[sector] || 0) + budget;
                });
            }

            const labels = Object.keys(sectorBudgetData);
            const data = Object.values(sectorBudgetData);
            const percentages = data.map(value => totalBudget > 0 ? (value / totalBudget * 100) : 0);
            
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ];

            charts.costCenterPie = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = percentages[context.dataIndex];
                                    return `${context.label}: ${formatNumber(context.parsed)} (${percentage.toFixed(1)}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Display sector percentages below the chart
            displaySectorPercentages(labels, data, percentages, colors);
        }

        function displaySectorPercentages(labels, data, percentages, colors) {
            const container = document.getElementById('sectorPercentages');
            let html = '';
            
            labels.forEach((label, index) => {
                const shortLabel = label.length > 25 ? label.substring(0, 25) + '...' : label;
                html += `
                    <div class="sector-item">
                        <div class="sector-name" style="color: ${colors[index]};">
                            <span style="display: inline-block; width: 12px; height: 12px; background: ${colors[index]}; border-radius: 50%; margin-left: 8px;"></span>
                            ${shortLabel}
                        </div>
                        <div class="sector-percentage">${percentages[index].toFixed(1)}%</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function createMonthlyTrendChart() {
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
            
            if (charts.monthlyTrend) {
                charts.monthlyTrend.destroy();
            }

            const months = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³'];
            const monthFilter = document.getElementById('monthFilter').value;
            let labels, budgetData, actualData;

            if (monthFilter) {
                // Show only the selected month
                labels = [monthFilter];
                budgetData = [filteredData.reduce((sum, row) => 
                    sum + (parseFloat(row[`Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${monthFilter}`]) || 0), 0)];
                actualData = [filteredData.reduce((sum, row) => 
                    sum + (parseFloat(row[`Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ${monthFilter}`]) || 0), 0)];
            } else {
                // Show all months
                labels = months;
                budgetData = months.map(month => 
                    filteredData.reduce((sum, row) => 
                        sum + (parseFloat(row[`Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${month}`]) || 0), 0));
                actualData = months.map(month => 
                    filteredData.reduce((sum, row) => 
                        sum + (parseFloat(row[`Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ${month}`]) || 0), 0));
            }

            charts.monthlyTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©',
                            data: budgetData,
                            borderColor: '#1e3c72',
                            backgroundColor: 'rgba(30, 60, 114, 0.1)',
                            tension: 0.4,
                            pointRadius: 5,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠ',
                            data: actualData,
                            borderColor: '#f5576c',
                            backgroundColor: 'rgba(245, 87, 108, 0.1)',
                            tension: 0.4,
                            pointRadius: 5,
                            pointHoverRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatNumber(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function createVarianceChart() {
            const ctx = document.getElementById('varianceChart').getContext('2d');
            
            if (charts.variance) {
                charts.variance.destroy();
            }

            const monthFilter = document.getElementById('monthFilter').value;
            const labels = filteredData.map(row => row['Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨']?.substring(0, 15) + '...' || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
            let varianceData;

            if (monthFilter) {
                varianceData = filteredData.map(row => {
                    const budget = parseFloat(row[`Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${monthFilter}`]) || 0;
                    const actual = parseFloat(row[`Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ${monthFilter}`]) || 0;
                    return budget > 0 ? ((actual - budget) / budget * 100) : 0;
                });
            } else {
                varianceData = filteredData.map(row => {
                    const budget = parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0;
                    const actual = parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0;
                    return budget > 0 ? ((actual - budget) / budget * 100) : 0;
                });
            }

            const colors = varianceData.map(variance => 
                variance > 0 ? 'rgba(255, 99, 132, 0.7)' : 'rgba(75, 192, 192, 0.7)'
            );

            charts.variance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù %',
                        data: varianceData,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('0.7', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `Ø§Ù†Ø­Ø±Ø§Ù: ${value.toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function createCostCenterCards() {
            const container = document.getElementById('costCenterCards');
            let cardsHTML = '';
            const monthFilter = document.getElementById('monthFilter').value;

            console.log("Creating cards for data:", filteredData); // Debug: Log data used for cards

            filteredData.forEach(row => {
                let budget, actual, remaining, utilizationRate;

                if (monthFilter) {
                    budget = parseFloat(row[`Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${monthFilter}`]) || 0;
                    actual = parseFloat(row[`Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ${monthFilter}`]) || 0;
                    remaining = budget - actual;
                    utilizationRate = budget > 0 ? (actual / budget * 100) : 0;
                } else {
                    budget = parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0;
                    actual = parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0;
                    remaining = parseFloat(row['Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©']) || 0;
                    utilizationRate = budget > 0 ? (actual / budget * 100) : 0;
                }
                
                let progressClass = 'under-budget';
                if (remaining < 0) {
                    progressClass = 'over-budget';
                } else if (remaining <= budget * 0.2) {
                    progressClass = 'warning-budget';
                }

                // Ensure cost center is properly handled
                const costCenter = row['Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©'] ? row['Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©'].toString().trim() : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                console.log(`Cost Center for ${row['Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}: ${costCenter}`); // Debug: Log each cost center

                cardsHTML += `
                    <div class="cost-center-card">
                        <div class="cost-center-header">
                            <div class="cost-center-title">${row['Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            <div>
                                <div class="cost-center-code">${row['Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                                <div class="cost-center-code" style="background: #e8f2ff; margin-top: 5px;">
                                    Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©: ${costCenter}
                                </div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9em;">
                            <div>
                                <strong>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©:</strong><br>
                                ${formatNumber(budget)}
                            </div>
                            <div>
                                <strong>Ø§Ù„Ù…ØµØ±ÙˆÙ:</strong><br>
                                ${formatNumber(actual)}
                            </div>
                            <div>
                                <strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong><br>
                                <span style="color: ${remaining < 0 ? '#d32f2f' : '#2e7d32'}">${formatNumber(remaining)}</span>
                            </div>
                        </div>
                        <div class="budget-progress">
                            <div class="budget-progress-bar ${progressClass}" style="width: ${Math.min(utilizationRate, 100)}%"></div>
                        </div>
                        <div style="text-align: center; font-size: 0.9em; margin-top: 5px;">
                            Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: ${utilizationRate.toFixed(1)}%
                        </div>
                    </div>
                `;
            });

            container.innerHTML = cardsHTML;
        }

        function generateInsights() {
            const insights = document.getElementById('insights');
            const summary = calculateSummary();
            const monthFilter = document.getElementById('monthFilter').value;
            
            let insightsHTML = '';

            // Budget utilization analysis
            const lowUtilization = filteredData.filter(row => {
                const budget = monthFilter ? (parseFloat(row[`Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${monthFilter}`]) || 0) : (parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0);
                const actual = monthFilter ? (parseFloat(row[`Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ${monthFilter}`]) || 0) : (parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0);
                return budget > 0 && (actual / budget) < 0.3;
            });

            const overBudget = filteredData.filter(row => {
                if (monthFilter) {
                    const budget = parseFloat(row[`Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${monthFilter}`]) || 0;
                    const actual = parseFloat(row[`Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ${monthFilter}`]) || 0;
                    return actual > budget;
                } else {
                    return (parseFloat(row['Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©']) || 0) < 0;
                }
            });

            insightsHTML += `
                <div class="insight-item">
                    ğŸ“Š <strong>Ù…Ø¹Ø¯Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${summary.utilizationRate.toFixed(1)}%
                    ${summary.utilizationRate < 50 ? ' - Ù…Ø¹Ø¯Ù„ Ù…Ù†Ø®ÙØ¶ Ù†Ø³Ø¨ÙŠØ§Ù‹' : summary.utilizationRate > 90 ? ' - Ù…Ø¹Ø¯Ù„ Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹' : ' - Ù…Ø¹Ø¯Ù„ Ù…ØªÙˆØ³Ø·'}
                </div>
            `;

            if (overBudget.length > 0) {
                insightsHTML += `
                    <div class="insight-item">
                        âš ï¸ <strong>ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©:</strong> ${overBudget.length} Ø­Ø³Ø§Ø¨ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ©
                        <br><small>Ø§Ù„Ø£ÙƒØ«Ø± ØªØ¬Ø§ÙˆØ²Ø§Ù‹: ${overBudget[0]['Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨']}</small>
                    </div>
                `;
            }

            if (lowUtilization.length > 0) {
                insightsHTML += `
                    <div class="insight-item">
                        ğŸ“‰ <strong>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù†Ø®ÙØ¶:</strong> ${lowUtilization.length} Ø­Ø³Ø§Ø¨ Ø¨Ù…Ø¹Ø¯Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ù‚Ù„ Ù…Ù† 30%
                        <br><small>ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ²ÙŠØ¹ Ø¬Ø²Ø¡ Ù…Ù† Ù…ÙŠØ²Ø§Ù†ÙŠØªÙ‡Ø§</small>
                    </div>
                `;
            }

            // Sector analysis
            const sectorBudgetData = {};
            const totalBudget = monthFilter ? 
                filteredData.reduce((sum, row) => sum + (parseFloat(row[`Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${monthFilter}`]) || 0), 0) :
                filteredData.reduce((sum, row) => sum + (parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0), 0);
            
            filteredData.forEach(row => {
                const sector = row['Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const budget = monthFilter ? (parseFloat(row[`Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${monthFilter}`]) || 0) : (parseFloat(row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø³Ø¨Ø¹Ø© Ø£Ø´Ù‡Ø±']) || 0);
                sectorBudgetData[sector] = (sectorBudgetData[sector] || 0) + budget;
            });

            const sortedSectors = Object.entries(sectorBudgetData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3);

            if (sortedSectors.length > 0) {
                const topSector = sortedSectors[0];
                const topSectorPercentage = totalBudget > 0 ? (topSector[1] / totalBudget * 100) : 0;
                
                insightsHTML += `
                    <div class="insight-item">
                        ğŸ† <strong>Ø£ÙƒØ¨Ø± Ù‚Ø·Ø§Ø¹ ÙÙŠ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©:</strong> ${topSector[0]}
                        <br><small>ÙŠØ´ÙƒÙ„ ${topSectorPercentage.toFixed(1)}% Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</small>
                    </div>
                `;
            }

            // Monthly analysis
            const months = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³'];
            let monthlySpending;

            if (monthFilter) {
                monthlySpending = [filteredData.reduce((sum, row) => sum + (parseFloat(row[`Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ${monthFilter}`]) || 0), 0)];
                insightsHTML += `
                    <div class="insight-item">
                        ğŸ“… <strong>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙÙŠ ${monthFilter}:</strong> ${formatNumber(monthlySpending[0])}
                    </div>
                `;
            } else {
                monthlySpending = months.map(month => 
                    filteredData.reduce((sum, row) => sum + (parseFloat(row[`Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ${month}`]) || 0), 0)
                );
                
                const maxSpendingMonth = months[monthlySpending.indexOf(Math.max(...monthlySpending))];
                const minSpendingMonth = months[monthlySpending.indexOf(Math.min(...monthlySpending))];

                insightsHTML += `
                    <div class="insight-item">
                        ğŸ“… <strong>Ø£Ø¹Ù„Ù‰ Ø´Ù‡Ø± ÙÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</strong> ${maxSpendingMonth} Ø¨Ù‚ÙŠÙ…Ø© ${formatNumber(Math.max(...monthlySpending))}
                    </div>
                    <div class="insight-item">
                        ğŸ“… <strong>Ø£Ù‚Ù„ Ø´Ù‡Ø± ÙÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</strong> ${minSpendingMonth} Ø¨Ù‚ÙŠÙ…Ø© ${formatNumber(Math.min(...monthlySpending))}
                    </div>
                `;
            }

            // Recommendations
            insightsHTML += `
                <div class="insight-item">
                    ğŸ’¡ <strong>Ø§Ù„ØªÙˆØµÙŠØ§Øª:</strong>
                    <ul style="margin-top: 10px; padding-right: 20px;">
                        ${overBudget.length > 0 ? '<li>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ²Ø© Ù„Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© ÙˆØªØ­Ø¯ÙŠØ¯ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</li>' : ''}
                        ${lowUtilization.length > 0 ? '<li>Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù‚Ù„ÙŠÙ„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</li>' : ''}
                        <li>ØªØ­Ø³ÙŠÙ† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ù…Ø§Ù„ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©</li>
                        <li>ÙˆØ¶Ø¹ Ù†Ø¸Ø§Ù… Ø¥Ù†Ø°Ø§Ø± Ù…Ø¨ÙƒØ± Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªÙ‚ØªØ±Ø¨ Ù…Ù† Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</li>
                        ${summary.utilizationRate < 70 ? '<li>ØªØ­Ø³ÙŠÙ† Ù…Ø¹Ø¯Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø§Ù„Ù…Ø®ØµØµØ©</li>' : ''}
                    </ul>
                </div>
            `;

            insights.innerHTML = insightsHTML;
        }

        function createDataTable() {
            const table = document.getElementById('dataTable');
            if (filteredData.length === 0) return;

            const monthFilter = document.getElementById('monthFilter').value;
            let headers;

            if (monthFilter) {
                // Show only relevant columns for the selected month plus general info
                headers = [
                    'Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©', 'Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨', 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„', 'Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨',
                    `Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${monthFilter}`, `Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ${monthFilter}`
                ];
            } else {
                headers = Object.keys(filteredData[0]);
            }
            
            let html = '<thead><tr>';
            headers.forEach(header => {
                let headerClass = '';
                if (header.includes('Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©')) headerClass = 'budget-column';
                else if (header.includes('Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ')) headerClass = 'actual-column';
                else if (header.includes('Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ')) headerClass = 'remaining-column';
                
                html += `<th class="${headerClass}">${header}</th>`;
            });
            html += '</tr></thead><tbody>';

            filteredData.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    const value = row[header];
                    let cellClass = '';
                    let displayValue = value;
                    
                    if (header.includes('Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©')) cellClass = 'budget-column';
                    else if (header.includes('Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ')) cellClass = 'actual-column';
                    else if (header.includes('Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ')) {
                        cellClass = parseFloat(value) < 0 ? 'negative-remaining' : 'positive-remaining';
                    }
                    
                    if (typeof value === 'number' && header !== 'Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨') {
                        displayValue = formatNumber(value);
                    }
                    
                    html += `<td class="${cellClass}">${displayValue || '-'}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody>';
            table.innerHTML = html;
        }

        function formatNumber(num) {
            if (num === 0) return '0';
            if (!num) return '-';
            return new Intl.NumberFormat('ar-EG', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(num);
        }

        // Export functions
        function printReport() {
            window.print();
        }

        function exportToExcel() {
            if (filteredData.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }

            const monthFilter = document.getElementById('monthFilter').value;
            let exportData = filteredData;

            if (monthFilter) {
                // Export only relevant columns for the selected month
                exportData = filteredData.map(row => ({
                    'Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©': row['Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©'],
                    'Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨': row['Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'],
                    'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„': row['Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„'],
                    'Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨': row['Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨'],
                    [`Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${monthFilter}`]: row[`Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© - ${monthFilter}`],
                    [`Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ${monthFilter}`]: row[`Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙØ¹Ù„ÙŠ - ${monthFilter}`]
                }));
            }

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©');
            XLSX.writeFile(wb, 'ØªØ­Ù„ÙŠÙ„_Ù…Ø±Ø§ÙƒØ²_Ø§Ù„ØªÙƒÙ„ÙØ©.xlsx');
        }

        function exportToPDF() {
            alert('Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…ÙŠØ²Ø© ØªØµØ¯ÙŠØ± PDF Ù‚Ø±ÙŠØ¨Ø§Ù‹');
        }

        // File drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            const fileUpload = document.querySelector('.file-upload');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                fileUpload.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                fileUpload.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                fileUpload.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                fileUpload.style.borderColor = '#1e3c72';
                fileUpload.style.background = '#f0f2ff';
            }

            function unhighlight(e) {
                fileUpload.style.borderColor = '#2a5298';
                fileUpload.style.background = '#f8f9ff';
            }

            fileUpload.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                document.getElementById('fileInput').files = files;
                handleFile(document.getElementById('fileInput'));
            }
        });
    </script>
</body>
</html>